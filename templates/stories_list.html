{% extends 'base.html' %}

{% block title %}Danh sách truyện - Comic Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Danh sách truyện</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0"><i class="fas fa-list me-2"></i>Danh sách truyện</h1>
                <button class="btn btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                    <i class="fas fa-filter me-2"></i>Bộ lọc
                </button>
            </div>
            <div class="collapse" id="filterCollapse">
                <div class="card-body bg-light">
                    <form action="{{ url_for('stories_list') }}" method="get" id="filter-form">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Website:</label>
                                <select class="form-select" name="website">
                                    <option value="">Tất cả website</option>
                                    {% for website in websites %}
                                        <option value="{{ website.id }}" {% if selected_filters.website_id == website.id %}selected{% endif %}>
                                            {{ website.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Thể loại:</label>
                                <select class="form-select" name="genre">
                                    <option value="">Tất cả thể loại</option>
                                    {% for genre in genres %}
                                        <option value="{{ genre }}" {% if selected_filters.genre == genre %}selected{% endif %}>
                                            {{ genre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Lượt xem tối thiểu:</label>
                                <input type="number" class="form-control" name="min_views" value="{{ selected_filters.min_views or '' }}">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Bình luận tối thiểu:</label>
                                <input type="number" class="form-control" name="min_comments" value="{{ selected_filters.min_comments or '' }}">
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-2"></i>Tìm kiếm
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <form action="{{ url_for('analyze_stories') }}" method="post" id="analyze-form">
                    <div class="d-flex justify-content-between mb-3">
                        <div>
                            <button type="button" class="btn btn-outline-primary me-2" id="select-all-btn">
                                <i class="fas fa-check-square me-2"></i>Chọn tất cả
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="deselect-all-btn">
                                <i class="fas fa-square me-2"></i>Bỏ chọn tất cả
                            </button>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-success" id="analyze-btn" disabled>
                                <i class="fas fa-chart-bar me-2"></i>Phân tích chuyên sâu
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 40px;"></th>
                                    <th>Tên truyện</th>
                                    <th>Tác giả</th>
                                    <th>Thể loại</th>
                                    <th>Chương</th>
                                    <th>Lượt xem</th>
                                    <th>Điểm cơ bản</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stories %}
                                    {% for story in stories %}
                                        <tr>
                                            <td>
                                                <div class="form-check">
                                                    <input class="form-check-input story-checkbox" type="checkbox" name="selected_stories" value="{{ story.id }}" id="story-{{ story.id }}">
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if story.cover_url %}
                                                        <img src="{{ story.cover_url }}" alt="{{ story.title }}" class="story-thumbnail me-2">
                                                    {% else %}
                                                        <div class="no-image-placeholder me-2">No image</div>
                                                    {% endif %}
                                                    <div>
                                                        <strong>{{ story.title }}</strong>
                                                        {% if story.alt_title %}
                                                            <div class="small text-muted">{{ story.alt_title }}</div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ story.author }}</td>
                                            <td>
                                                {% if story.genres %}
                                                    {% set genre_list = story.genres.split(',') %}
                                                    {% for genre in genre_list[:3] %}
                                                        <span class="badge bg-secondary">{{ genre }}</span>
                                                    {% endfor %}
                                                    {% if genre_list|length > 3 %}
                                                        <span class="badge bg-secondary">+{{ genre_list|length - 3 }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ story.chapter_count }}</td>
                                            <td>{{ story.views|default(0)|thousandSeparator }}</td>
                                            <td>
                                                {% if story.base_rating %}
                                                    <span class="rating rating-{{ (story.base_rating / 2)|round|int }}">
                                                        {{ story.base_rating|round(1) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if story.has_analyzed_comments %}
                                                    <span class="badge bg-success">Đã phân tích</span>
                                                {% else %}
                                                    <span class="badge bg-warning text-dark">Chưa phân tích</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <div class="empty-state">
                                                <i class="fas fa-search fa-3x mb-3"></i>
                                                <h5>Không tìm thấy truyện nào</h5>
                                                <p>Hãy thử thay đổi bộ lọc hoặc crawl thêm dữ liệu mới</p>
                                                <a href="{{ url_for('index') }}" class="btn btn-primary mt-2">
                                                    <i class="fas fa-spider me-2"></i>Crawl dữ liệu mới
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="card-footer text-muted">
                {% if stories %}
                    <span>Hiển thị {{ stories|length }} truyện</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .story-thumbnail {
        width: 40px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .no-image-placeholder {
        width: 40px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-size: 10px;
        color: #888;
    }
    
    .rating {
        display: inline-block;
        padding: 3px 6px;
        border-radius: 4px;
        font-weight: bold;
    }
    
    .rating-0, .rating-1, .rating-2 {
        background-color: #ffcdd2;
        color: #c62828;
    }
    
    .rating-3 {
        background-color: #fff9c4;
        color: #827717;
    }
    
    .rating-4, .rating-5 {
        background-color: #c8e6c9;
        color: #2e7d32;
    }
    
    .empty-state {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.story-checkbox');
        const selectAllBtn = document.getElementById('select-all-btn');
        const deselectAllBtn = document.getElementById('deselect-all-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const analyzeForm = document.getElementById('analyze-form');
        
        // Thiết lập các hàm xử lý
        function updateAnalyzeButton() {
            const checkedCount = document.querySelectorAll('.story-checkbox:checked').length;
            analyzeBtn.disabled = checkedCount === 0;
            
            if (checkedCount > 0) {
                analyzeBtn.textContent = `Phân tích ${checkedCount} truyện`;
            } else {
                analyzeBtn.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Phân tích chuyên sâu';
            }
        }
        
        // Xử lý sự kiện cho checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateAnalyzeButton);
        });
        
        // Xử lý nút Chọn tất cả
        selectAllBtn.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateAnalyzeButton();
        });
        
        // Xử lý nút Bỏ chọn tất cả
        deselectAllBtn.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateAnalyzeButton();
        });
        
        // Xử lý form submit
        analyzeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            fetch('{{ url_for("analyze_stories") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.redirect) {
                    // Lưu dữ liệu vào localStorage để sử dụng ở trang tiếp theo
                    localStorage.setItem('analyze_data', JSON.stringify(data.data));
                    window.location.href = data.redirect;
                } else {
                    alert(data.message || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xử lý yêu cầu');
            });
        });
        
        // Khởi tạo
        updateAnalyzeButton();
    });
</script>
{% endblock %}