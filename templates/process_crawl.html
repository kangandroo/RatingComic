{% extends 'base.html' %}

{% block title %}Đang Crawl - Comic Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Đang Crawl</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 offset-lg-2">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h3 mb-0"><i class="fas fa-cogs me-2"></i>Đang thu thập dữ liệu</h1>
            </div>
            <div class="card-body">
                <div id="status" class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Đang chuẩn bị crawl...
                </div>
                
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div class="log-container">
                    <h5><i class="fas fa-terminal me-2"></i>Log:</h5>
                    <div id="log-output" class="log-output"></div>
                </div>
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('index') }}" class="btn btn-secondary me-2" id="cancel-btn">
                    <i class="fas fa-times me-2"></i>Hủy
                </a>
                <a href="{{ url_for('stories_list') }}" class="btn btn-success disabled" id="view-results-btn">
                    <i class="fas fa-list me-2"></i>Xem kết quả
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .log-output {
        height: 350px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        background-color: #f8f9fa;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
        margin-bottom: 10px;
    }
    
    .log-message {
        margin-bottom: 4px;
        padding: 2px 0;
        border-bottom: 1px solid #eee;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const socket = io();
        const logOutput = document.getElementById('log-output');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress-bar');
        const viewResultsBtn = document.getElementById('view-results-btn');
        
        // Lấy dữ liệu từ localStorage
        const crawlData = JSON.parse(localStorage.getItem('crawl_data'));
        
        if (!crawlData) {
            logOutput.innerHTML += '<div class="log-message text-danger">Không tìm thấy thông tin crawl</div>';
            return;
        }
        
        // Cập nhật trạng thái
        statusDiv.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Đang chuẩn bị crawl dữ liệu từ ${crawlData.website_name}...`;
        
        // Bắt đầu crawl qua socket
        socket.emit('start_crawl', crawlData);
        
        // Xử lý log message
        socket.on('log_message', function(message) {
            const logMessage = document.createElement('div');
            logMessage.className = 'log-message';
            logMessage.textContent = message;
            logOutput.appendChild(logMessage);
            logOutput.scrollTop = logOutput.scrollHeight;
            
            // Ước lượng tiến độ từ message
            if (message.includes('Đã hoàn thành') && message.includes('/')) {
                try {
                    const parts = message.match(/\[(\d+)\/(\d+)\]/);
                    if (parts && parts.length === 3) {
                        const current = parseInt(parts[1]);
                        const total = parseInt(parts[2]);
                        const percent = Math.round((current / total) * 100);
                        progressBar.style.width = `${percent}%`;
                    }
                } catch (e) {
                    console.error('Error parsing progress:', e);
                }
            }
        });
        
        // Xử lý khi hoàn thành
        socket.on('crawl_completed', function(data) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Đã hoàn thành quá trình crawl!';
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            
            // Kích hoạt nút xem kết quả
            viewResultsBtn.classList.remove('disabled');
            
            // Tự động chuyển hướng sau 3 giây
            setTimeout(function() {
                window.location.href = data.redirect;
            }, 3000);
        });
    });
</script>
{% endblock %}